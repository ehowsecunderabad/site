<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Latest Replays</title>
<style>
  :root {
    color-scheme: light dark;
    /* Set a responsive base font size that scales from ~16px to ~18px */
    font-size: clamp(1rem, 0.95rem + 0.25vw, 1.125rem);
  }
  body {
    font-family: system-ui, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    margin: 0;
    max-width: 1280px;
    margin-inline: auto;
  }
  h1 {
    /* Make the main heading responsive */
    font-size: clamp(1.75rem, 1rem + 2vw, 2.5rem);
    text-align: center;
  }
  .grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; width: 100%; }
  .card { border: 1px solid #ddd; border-radius: 10px; overflow: hidden; background: #fff; flex: 1 1 300px; max-width: 340px; }
  .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); transition: all 0.2s; }
  .thumb { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; }
  .meta { padding: 0.8rem; }
  .title { font-weight: 600; margin: 0 0 0.35rem; font-size: 1.1rem; }
  .time { color: #555; font-size: 0.95rem; }
  .actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
  .btn { padding: 0.45rem 0.7rem; border: 1px solid #ccc; background: #f8f8f8; border-radius: 6px; cursor: pointer; }
  iframe { width: 100%; max-width: 960px; height: 540px; border: none; border-radius: 10px; margin: 1rem 0; }
</style>
</head>
<body>

<h1>Latest Replays</h1>

<!-- Selected embed container -->
<div id="embed-container" hidden>
  <iframe id="player" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
</div>

<!-- List container -->
<div id="list" class="grid" role="list"></div>

<script>
  // Fetch past streams from a local cache file
  async function fetchPastWeekStreams() {
    // This file would be generated by your server-side caching script
    // The script would run every 5-10 minutes and call the YouTube API
    // to create/update 'past_week_cache.json'.
    const cacheUrl = 'https://ehowsecunderabad.github.io/site/past_week_cache.json';
    
    // Add a cache-busting query parameter to prevent browser caching issues
    const res = await fetch(`${cacheUrl}?t=${new Date().getTime()}`);
    if (!res.ok) throw new Error(`API error: ${res.status}`);
    const data = await res.json();
    return data.items || [];
  }

  // Render cards
  function renderList(items) {
    const list = document.getElementById("list");
    list.innerHTML = "";
    if (!items.length) {
      list.innerHTML = "<p>No completed live streams found from the past week.</p>";
      return;
    }

    items.forEach(item => {
      const vid = item.id; // The new cache contains video objects, where the ID is at the root.
      const s = item.snippet;
      const thumb = (s.thumbnails.high || s.thumbnails.medium || s.thumbnails.default).url;
      const publishedTime = s.publishedAt;
      const date = new Date(publishedTime);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img class="thumb" src="${thumb}" alt="Thumbnail for ${escapeHtml(s.title)}" />
        <div class="meta">
          <h3 class="title">${escapeHtml(s.title)}</h3>
          <div class="time">Streamed: ${date.toLocaleString([], { dateStyle: "medium", timeStyle: "short" })}</div>
          <div class="actions">
            <button class="btn" data-vid="${vid}" data-title="${escapeHtml(s.title)}">Watch here</button>
            <a class="btn" href="https://www.youtube.com/watch?v=${vid}" target="_blank" rel="noopener noreferrer">Open on YouTube</a>
          </div>
        </div>
      `;
      card.querySelector("button[data-vid]").addEventListener("click", (e) => {
        const videoId = e.currentTarget.getAttribute("data-vid");
        showEmbed(videoId);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      list.appendChild(card);
    });
  }

  function showEmbed(videoId) {
    const container = document.getElementById("embed-container");
    const player = document.getElementById("player");
    player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
    container.hidden = false;
  }

  // Simple HTML escape
  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
  }

  // Init
  (async () => {
    try {
      const items = await fetchPastWeekStreams();
      renderList(items);
    } catch (err) {
      console.error(err);
      document.getElementById("list").innerHTML = "<p>Failed to load past week streams.</p>";
    }
  })();
</script>
</body>
</html>
